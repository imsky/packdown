/** 
 * Packdown - files in Markdown
 * Version 0.9.99
 * Â© 2020 Ivan Malopinsky
 */
!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(n=n||self).Packdown=e()}(this,function(){"use strict";var l=/^(#{1,6}) \/([a-z0-9.,_()/-]+)$/i,d=/^```([a-z0-9][a-z0-9-]*)?$/i,m="packdown:/",h="\n";function v(n,e){return{name:n,headingLevel:e,details:[],infoString:void 0,content:[]}}function g(){return{files:{},content:[]}}function s(n){return"    "===n.slice(0,4)}function f(n){n=String(n);n.slice(-1)!==h&&(n+=h);for(var e={},t=g(),r=null,i=null,o=0,f=n.split(h);o<f.length;o+=1){var a=f[o],c=a.match(l),u=a.match(d);if(c){if(r)throw Error("Unexpected file");r=v(c[2],c[1].length),e[(t.files[r.name]=r).name]=!0}else if(r&&u){u=u&&u[1];if(i){if(u||!e[r.name])throw Error("Invalid code block");delete e[r.name],r.content=function(n){var e=!1,t=0;if(1<n.length)for(var r=0;r<n.length;r++){var i=n[r];if(i.length)if(s(i)){if(1<++t){e=!0;break}}else if(0===r){e=!1;break}}else 1===n.length&&s(n[0])&&(e=!0);return e?n.map(function(n){return n.replace(/^ {4}/,"")}):n}(r.content),t.content.push(""+m+r.name),i=r=null}else r.infoString=u,i=!0}else(r&&!i?r.details:(r&&i?r:t).content).push(a)}if(r||i)throw Error("Truncated input");return t}function p(n){var e=n.content,o=n.files;if(!e||!o)throw Error("Document content or files missing");if(!Array.isArray(e))throw Error("Document content not an array");if(Object(o)!==o)throw Error("Document files not an object");return e.map(function(n){if(0!==n.indexOf(m))return n;var e=n.slice(m.length),t=o[e],r=t.name,i=t.headingLevel,n=t.details,e=t.infoString;void 0===e&&(e="");t=t.content;return[Array(Math.max(2,(i||1)+1)).join("#")+" /"+r,n.join(h),"```"+e,t.join(h),"```"].join(h)}).join(h)}return{read:f,write:p,commandFactory:function(n){var l=n.readFile,t=n.readDir,d=n.joinPath,s=n.writeFile;return d=d||function(n,e){return n+"/"+e},Object.freeze({unpack:function(n,i,o){l(n,function(n,e){if(n)return o(n);var t=f(e),r=Object.keys(t.files);if(!r.length)return o();r.forEach(function(n,e){n=t.files[n];s(d(i,n.name),n.content.join(h),function(n){return n?o(n):e===r.length-1?o():void 0})})})},pack:function(e,c,u){function o(o,f){var a=!1;o.forEach(function(r,i){a||l(d(e,r),function(n,e){if(n)return a=!0,u(n);var t=f.files[r],n=t||v(r,null);n.content=e.split(h),f.files[r]=n,t||f.content.push(""+m+r),i===o.length-1&&s(c,p(f),u)})})}t(e,function(n,t){if(n)return u(n);if(!Array.isArray(t))return u("Files not an array");if(!t.length)return u();var r=g(),i=-1!==t.map(function(n){return n.toLowerCase()}).filter(function(n){return"index.md"===n||"readme.md"===n}).indexOf("index.md")?"index.md":-1!==t.indexOf("readme.md")?"readme.md":null;i?l(d(e,i),function(n,e){if(n)return u(n);n=f(e),e=t;Object.keys(n.files).length&&(r=n,e=t.filter(function(n){return n!==i})),o(e,r)}):o(t,r)})}})},version:"0.9.99"}});
